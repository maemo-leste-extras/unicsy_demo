#!/usr/bin/python3
# -*- python -*-

from __future__ import print_function

import sys
sys.path += [ "/usr/share/unicsy/lib" ]

import os
import time
import hardware
import watchdog

#os.system("setterm -blank 1")

def run():
    wd = watchdog.Watchdog("battery")
    bat = hardware.hw.battery
    last_counter = None
    step = 30
    while 1:
        bat.run()
        s = bat.summary()
        s2 = bat.handle_protect()
        if s2: s = s2

        wd.write(s, "%d%%" % bat.perc)
        if last_counter is None:
            aacur = 0
        else:
            # in mAh
            aacur = (bat.charge_now - last_counter) / (step/3600)
            # WTF? Is that right?

        if True:
            print("utime=%.3f"% time.time(),
                  "batvolt=%.3f" % bat.volt,
                  "bativolt=%.3f" % bat.volt3,
                  "batperc=%.1f" % bat.perc,
                  "batiperc=%.1f" % bat.perc3,
                  "batcur=%.5f" % bat.current,
                  "batacur=%.5f" % bat.current_avg,
                  "bataacur=%f" % aacur,
                  "charge=%f" % bat.charge_now)
        last_counter = bat.charge_now
        sys.stdout.flush()
        time.sleep(step)

run()
